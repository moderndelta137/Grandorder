# Sprint 2 作業プラン（次スプリント繰越分を含む）

最終更新: 現在スレッド  
担当: Codex  
参照仕様: `docs/GDD.md`, `docs/V1_PLAN.md`, `docs/SCENARIO_CHAPTER_PLAN.md`
進捗メモ: Step A/B/C/D完了。Step Dで章本文命名規約と第1-2章プレースホルダ挿入口を実装。

---

## 1. Sprint 2の目的

Sprint 2は「戦闘核の品質底上げ」と「次スプリントに繰り越す基盤タスクの先行処理」を同時に進める。

- 戦闘の納得感を上げる（クラス相性を実装）。
- 召喚体験の再現性を上げる（相性ロジック強化）。
- 周回プレイの実用性を上げる（セーブ/ロード + 既読制御）。
- Sprint 3の章本文投入に向け、実装ガイドラインと受け皿を整える。

---

## 2. スコープ

### 2.1 Must（Sprint 2内で完了）
1. **クラス相性表の実装**
   - 7基本クラス間の有利/不利/等倍を定義。
   - 戦闘判定に相性補正を統合。
   - UIログに「相性有利/不利」の理由を表示。

2. **召喚相性ロジックの強化（v2）**
   - 触媒一致、主人公ビルド、陣営状態、章進行で重み補正。
   - 召喚結果が極端に偏らないよう上限/下限を設定。
   - デバッグ用に召喚重み内訳をログ出力可能にする。

3. **セーブ/ロード + 既読制御の最小実装**
   - ブラウザ `localStorage` に保存スロット（最小3枠）。
   - ロード時のバージョン不整合を検知し、警告を表示。
   - 既読シーンのスキップ速度を段階化（等速/高速）。

### 2.2 Should（時間があれば実施）
4. **戦闘ログ強化**
   - ダメージ理由（基礎値、相性、スキル補正）を簡易表示。

5. **章本文投入の準備作業**
   - `SCENES` 章内本文エントリの命名規約を固定。
   - 第1章/第2章の本文受け皿だけ先に作る（本文そのものは次スプリント）。

### 2.3 Out of Scope（Sprint 2ではやらない）
- 第3章以降の本文大量投入。
- 大規模な演出改修（画面デザイン刷新、アニメーション追加）。
- 新規エクストラクラスの実装。

---

## 3. 実装順（推奨）

### Step A（前半）: 戦闘の信頼性を先に固める
- A-1: クラス相性表データ作成
- A-2: 戦闘計算式へ統合
- A-3: 回帰テスト（通常攻撃/宝具/撤退/令呪突破）

### Step B（中盤）: 召喚の改善
- B-1: 召喚重みの分解（触媒/ビルド/補正）
- B-2: 極端値のクリップ処理
- B-3: 1,000回サンプルで分布確認

### Step C（後半）: 運用機能
- C-1: セーブ/ロードUIと状態シリアライズ
- C-2: 既読制御フラグ追加
- C-3: 保存データ互換性チェック

### Step D（バッファ）: 次スプリント準備
- D-1: 章本文用シーン命名規約の確定
- D-2: 第1章・第2章の本文挿入口だけ実装

---

## 4. タスク分解（1タスク30〜90分）

1. 相性テーブル定義ファイル追加（30分）
2. 攻撃側/防御側クラス参照の統合（45分）
3. 判定ログへ相性係数表示（30分）
4. 相性込みの戦闘ユニットテスト追加（60分）
5. 召喚重み関数を `buildBonus` 依存から分離（60分）
6. 触媒一致率テスト（1,000回シミュレーション）（45分）
7. セーブスロット3枠UI追加（60分）
8. 状態の保存/復元（令呪、看破、章進行を含む）（90分）
9. 既読シーン判定とスキップ速度実装（60分）
10. ロード失敗時のフォールバック導線（45分）
11. 章本文シーン命名ルールの文書化（30分）
12. 第1章・第2章の本文プレースホルダ接続（45分）

---

## 5. 受け入れ条件（Doneの定義）

1. 同条件戦闘で、クラス相性の有無により勝率差が再現される。
2. 召喚結果が「触媒・ビルド選択」に応じて統計的に変化する。
3. セーブ→再読込で以下が一致する：
   - 章進行、令呪残数、看破Lv、救済使用フラグ、敵残存数。
4. 既読スキップで進行破綻（未定義シーン遷移）が発生しない。
5. 既存エンディング4種への到達可否が回帰で維持される。

---

## 6. 検証コマンド（予定）

- `node --check src/scenario.js`
- `node --check src/game.js`
- `node scripts/generate_csv_data.mjs`
- `node scripts/simulate_battle.mjs`
- `node --input-type=module scripts/simulate_summon.mjs`

---

## 7. リスクと回避策

- **リスク1: 相性補正が強すぎて戦闘が単調化**
  - 対策: 係数を段階的に調整（例: 1.2 / 0.8 から開始）。

- **リスク2: セーブ形式変更で過去データが壊れる**
  - 対策: `saveVersion` を持ち、互換外は警告して新規開始へ誘導。

- **リスク3: 章本文投入と競合して進行が不安定化**
  - 対策: Sprint 2では本文を最小プレースホルダに限定し、本文量はSprint 3へ分離。

---

## 8. Sprint 3への引き継ぎ

Sprint 2完了後、次の順でSprint 3へ移行する。

1. 第1章・第2章本文の本実装（必須2 + 任意1シーン/章）。
2. 第3章・第4章本文の本実装（中盤リカバリー分岐を含む）。
3. 第5章・第6章本文と4エンディング文面の厚み追加。
4. テキスト総量5万字以内の最終調整。
