# 開発進捗ログ（Sprint 1〜4）

最終更新: 現在スレッド
担当: Codex
参照仕様: `docs/GDD.md`, `docs/V1_PLAN.md`

---

## 1. 進捗サマリー

- [x] Sprint 1（基盤 / 召喚導入）
- [x] Sprint 2（判定エンジン / 夜戦ループ）
- [x] Sprint 3（7騎反映 / 章進行相当の周回ループ）
- [x] Sprint 4（救済導線 / 結末分岐 / 仕上げ）

> 現在のビルドは、V1_PLANの全Sprint要件を最小実装で通した統合版。

---

## 2. 実装済み内容（最終）

### 2.1 コア基盤
- `createStore(getState/update/reset)` による状態一元管理。
- シーン駆動（`SCENES`）で分岐を管理。
- UIステータスを拡張（看破進行、残存敵、救済状態、結末判定）。

### 2.2 召喚・契約（Sprint 1）
- 主人公ビルド選択（血統型 / 現場型 / 研究型）。
- 触媒選択（4種）と重み付き召喚。
- FSN登場英霊7騎プールで召喚。
- 真名秘匿維持 + 原典と異なるクラス現界の可能性。

### 2.3 戦闘・情報戦（Sprint 2〜3）
- 共通判定関数 `runCheck()` 実装。
- 昼行動（情報収集/工房整備/先制配置）から夜戦へ接続。
- 夜戦行動（通常攻撃/宝具/令呪突破/令呪離脱/撤退）。
- 真名看破進行値（0〜3）と露見処理。
- 敵6陣営の撃破進行と最終戦解放。

### 2.4 サーヴァント個別戦闘効果（V1品質向上）
- FSN初期7騎それぞれに固有スキル補正を追加（ボーナス/被ダメ軽減/撤退補助など）。
- 宝具選択時に英霊別の追加補正と専用ログを反映。
- 宝具の1戦闘1回制限を強制（再使用時は通常攻撃へ自動変換）。

### 2.5 判定タグ連動（V1品質向上）
- 戦闘行動と敵クラスから `checkTags` を生成。
- サーヴァント別タグスキルと一致時に補正（攻撃/防御/撤退/魔力）を適用。
- 発動時はログにタグ一致とスキル名を表示。

### 2.6 令呪・救済・結末（Sprint 4）
- 令呪3画消費処理（突破/離脱/最終戦確定）。
- 救済導線（1周1回）の発動と代償適用。
- 最終戦後に4種の結末判定：
  - 正統勝利
  - 代償勝利
  - 救済生還
  - 破滅

### 2.7 情報開示型看破（V1仕様反映）
- 夜戦の敵情報パネルを追加し、未開示情報を `???` 表示。
- 情報収集で敵ごとの看破Lvを上昇させ、ステータス→スキル→真名/宝具の順で段階開示。
- 敵が戦闘中に使用したスキル/宝具は即時公開。

### 2.8 NPC陣営AI（V1品質向上）
- 昼行動後に他陣営ターンを進行し、交戦/潜伏/同盟工作を実行。
- 他陣営同士のHP増減と脱落を進行ログへ反映。
- 残存陣営が少数化した場合は最終局面フラグを前倒し解放。

### 2.9 データ管理（CSV分割）
- サーヴァント基礎値/戦闘補正/タグ補正/看破開示ルールを `data/csv` へ分割。
- `scripts/generate_csv_data.mjs` で `src/data/generatedData.js` を生成し、実行時データとして利用。

### 2.10 戦闘回帰テスト（Sprint2 A-3）
- `scripts/simulate_battle.mjs` を追加し、通常攻撃/宝具/令呪突破/撤退の回帰を200試行で自動検証可能化。
- 戦闘ログ上でクラス相性ログの出力と、数値状態のNaN混入がないことを検証。

### 2.11 召喚相性ロジック強化（Sprint2 Step B）
- `summonServant` を重み分解型に改修（触媒/ビルド/章/同盟/乱数）。
- 極端な偏りを抑えるため、最終スコアにクリップ（下限/上限）を適用。
- `scripts/simulate_summon.mjs` で 1000 回×（3ビルド×4触媒）の分布検証を追加。

### 2.13 セーブ/ロード + 既読制御（Sprint2 Step C）
- `localStorage` 3スロット保存（`saveVersion`付き）と読込時の互換外/破損チェックを追加。
- 保存対象にシーンID・ゲーム状態・スキップ設定を含め、再開時に復元。
- 既読シーンの単一選択肢に対して、等速/高速の既読スキップを実装。

### 2.15 章本文挿入口（Sprint2 Step D）
- `docs/SCENE_NAMING_RULE.md` を追加し、章本文シーン命名規約（`chapter{n}_{type}_{nnn}`）を定義。
- `src/scenario.js` に第1章・第2章の本文プレースホルダ（`chapter1_main_001/002`, `chapter2_main_001/002`）を接続。

### 2.16 章構成シナリオのゲーム内接続（今回反映）
- 6章（召喚の夜〜聖杯到達）をゲーム状態へ接続し、進行度に応じて章導入と目的表示を切替。
- 中盤（第4章まで）限定のリカバリー導線を追加し、失敗時の再編を代償付きで許容。
- 終盤（第5章以降）で不可逆分岐へ移行するフラグ固定を導入。
- 理想点/一般被害/同盟状態を日中行動に連動させ、結末判定へ反映。
- 第5章/第6章の日中イベント連動を追加し、情報収集・工房整備・先制配置が終盤フラグ（看破進行/理想点/令呪/被害/戦術補正）へ反映されるよう更新。

### 2.17 Sprint3 Step D 完了（D-1 / D-2）
- `scripts/count_story_chars.mjs` を追加し、章本文+エンディングの文字数を章別目標と総目標49,500字で集計可能化。
- `scripts/validate_sprint3_d2.mjs` を追加し、命名規約・章入口・`???`開示と看破連動ルールを自動検証可能化。
- `docs/SPRINT3_PLAN.md` の検証コマンドへ両スクリプトを追記。


### 2.18 Sprint3 Step D-3 完了（最終回帰）
- `scripts/validate_sprint3_d3.mjs` を追加し、以下3項目を自動回帰可能化。
  - 第1章開始〜第2章同盟分岐
  - 第4章失敗時の中盤リカバリー導線
  - 第6章到達後の4エンディング出し分け
- `docs/SPRINT3_PLAN.md` の進捗ステータスをD-3完了へ更新。


### 2.19 Sprint4 Step A 完了（昼ランダムイベント基盤）
- `data/csv/day_events.csv` を追加し、共通/ビルド専用/味方真名専用/敵生存真名専用の基礎イベント定義を投入。
- `scripts/generate_csv_data.mjs` と `src/data/generatedData.js` に `DAY_EVENTS` 生成を追加。
- `src/scenario.js` に日中ランダムイベント抽選・適用の基盤（カテゴリ重み + no-opフォールバック）を追加。
- 現時点はStep A方針に合わせ、選択肢なしイベントの適用を先行実装。

### 2.20 Sprint4 Step B-1 完了（共通イベント拡張）
- `data/csv/day_events.csv` の共通イベントを12本以上へ拡張（no-opを除く）。
- 章帯や敵残存数に応じた共通イベント条件（`enemyAlive>=n`, `allianceState=none` など）を追加。
- 低リスク効果（看破/魔力/HP/理想点/一般被害/戦術優位/停戦遷移）の組み合わせを投入し、日中変化量を多様化。

### 2.21 日中イベント遷移モデル調整（戦闘/ランダム分岐）
- 日中行動後は `dayEncounterCheck` を経由し、「戦闘発生」または「日中ランダムイベント発生」を分岐させる方式へ変更。
- ランダムイベント発生時は `dayRandomEvent`（本文+選択肢）→`dayRandomEventResult`（結果表示）→`dayAction` に戻る流れを実装。
- 行動別の発生率を導入（先制配置は戦闘寄り、工房整備はランダム寄り）し、工房整備時にビルド/サーヴァント関連カテゴリ比率が上がるようカテゴリバイアスを追加。


### 2.22 Sprint4 Step B-3 完了（味方7 + 敵6）
- `data/csv/day_events.csv` に味方真名専用7本・敵生存真名専用6本を追加。
- 味方側は「マスターとの関係性」を主軸にした2択イベントを中心に構成し、敵側は生存敵真名に応じた圧力イベントを追加。
- `scripts/generate_csv_data.mjs` 再生成により `src/data/generatedData.js` へ反映。

### 2.23 日中イベント条件評価拡張（真名条件）
- `src/scenario.js` の `evaluateOneCondition()` へ以下を追加。
  - `playerServant=<trueName>`（自陣契約サーヴァントの真名一致）
  - `enemyServant=<trueName>`（生存敵陣営に該当真名が存在）
- これにより真名ベースでの味方/敵専用イベント抽選が成立。


### 2.24 Sprint4 Step B-2 完了（ビルド専用6本）
- `data/csv/day_events.csv` の `masterBuild` イベントを3本追加し、合計6本へ拡張。
- 追加内訳:
  - 血統型: 契約維持寄りの誓約術式イベント
  - 現場型: 避難導線・連絡網再編イベント
  - 研究型: 解析結果を夜戦配置へ転用する対策イベント
- これにより Sprint4 Step B（B-1/B-2/B-3）が完了し、残タスクは Step C（期待値調整）以降。



### 2.25 Sprint4 Step C-1/C-2 完了（分岐期待値 + ログ可読化）
- `src/scenario.js` の `DAY_EVENT_OPTION_TEMPLATES` を拡張し、B-2で追加したビルド専用3本にも2択分岐を付与。
- 期待値の偏りが強すぎないよう、各分岐を「継戦安定」「夜戦優位」「被害抑制」系のトレードオフへ再設計。
- `applyDayEventOutcome()` を拡張し、看破/被害/同盟を含む主要値の before/after 差分を `変動:` サマリとして自動生成。
- `dayRandomEventResult` で結果本文に変動サマリを追記し、`state.log` にも同内容を保存して追跡性を向上。



### 2.26 Sprint4 Step D-1 完了（1000回分布検証）
- `scripts/simulate_day_events.mjs` を新規追加し、日中イベント抽選を行動別に1000回×3（合計3000回）で検証。
- 検証項目:
  - カテゴリ分布が `共通 > 味方真名 > ビルド > 敵真名` を満たすこと
  - 抽選失敗率 0%（`dayEvent.category` 未設定が発生しないこと）
- 現行結果（合計3000回）:
  - common: 1361（45.37%）
  - playerServant: 810（27.0%）
  - masterBuild: 499（16.63%）
  - enemyServant: 330（11.0%）
- 残タスクは Step D-2（セーブ/ロード互換確認）と D-3（既存エンド回帰）。



### 2.27 Sprint4 Step D-2 完了（セーブ/ロード互換確認）
- `scripts/validate_sprint4_d2.mjs` を追加。
- 検証項目:
  - 現行セーブJSONの round-trip 読込
  - 旧形状（`dayEvent.deltaSummary` / `flags.readScenes` 欠落）の互換読込
  - 互換外versionの拒否

### 2.28 Sprint4 Step D-3 完了（既存エンド回帰）
- `scripts/validate_sprint4_d3.mjs` を追加。
- 検証項目:
  - 4エンディング（正統勝利 / 代償勝利 / 救済生還 / 破滅）の判定回帰
  - `scripts/validate_sprint3_d3.mjs` の基準チェックが引き続き通過すること
- これにより Sprint4 Step D（D-1〜D-3）が完了。



### 2.29 Sprint5計画着手（V1シナリオ完成スプリント）
- `docs/SPRINT5_PLAN.md` を新規作成し、V1タスクとして「総文字数5万字管理 + 章本文補完 + 回帰確認」を定義。
- Sprint4完了後の次段階を「V2機能追加」ではなく、まずV1本文密度の完成へ寄せる方針を明文化。




### 2.30 UI演出微調整（入力体験・表示遷移）
- `src/game.js` にボタン押下エフェクトバインドとシーン本文遷移トリガを追加。
- `styles/main.css` でボタンの押し心地（hover/press）とモーダル開閉アニメーションを追加。
- 対象は演出のみで、戦闘判定・分岐・セーブ仕様は非変更。
- 回帰確認は既存 `scripts/validate_sprint4_d3.mjs` を継続利用。

### 2.31 Sprint5 Step B-1a 着手（第1章本文の先行増補）
- `src/scenario.js` の `chapter1_main_001` / `chapter1_main_002` 本文を増補し、導入・対立・決断・余韻の密度を強化。
- 第2章以降へ横展開する前提として、第1章単体での体験改善を先行検証する方針を反映。
- 検証として文字数計測と既存回帰（Sprint3 D-3 / Sprint4 D-3）を実行し、分岐・結末非破壊を確認。


### 2.32 Sprint5 Step B-1a 改訂（短シーン分割 + 呼称統一）
- `src/scenario.js` の第1章本文を `chapter1_main_001`〜`006` に分割し、1シーンあたりの表示密度を圧縮。
- 呼称ルールを統一（サーヴァント→「マスター」、主人公→クラス名呼び）し、会話対象の判別性を改善。
- 導入文と戦況更新を交互配置し、本文と夜戦準備の分断を緩和（戦況速報の短文差し込みを追加）。
- 選択肢タグは導入せず、既存方針どおりタグなしで運用。


### 2.33 Sprint5 Step B-1a 会話自然化改訂（没入重視）
- 第1章本文から「章番号を直接語る」などの第四の壁表現を除去し、プレイヤー視点の没入感を優先。
- 呼称統一（マスター / クラス名）は維持しつつ、会話を説明口調から自然な応答へ改稿。
- シナリオ運用メモは `src/scenario.js` 側の非表示コメントとして保持し、表示本文と分離。

### 2.34 プロット統括ドキュメント新設（ライティング前提整備）
- `docs/PLOT_MASTER.md` を新規作成し、章別の遭遇点・分岐開始点・分岐方向・固定/通常夜戦接続ルールを一元化。
- シナリオ本文と設計メモを分離する運用を文書化し、今後の拡張時の齟齬を抑制。
- Sprint5計画側にも参照を追記し、以後のシナリオ作業は本ドキュメント更新を前提化。

### 2.35 第1章プロット時空間改訂（作中時刻 + 場所遷移）
- `docs/PLOT_MASTER.md` の「いつ」を作中日時（例: 10/1 23:00）として定義し、章内時間経過の記法を明文化。
- 第1章にシーン接続表（`chapter1_main_001`〜`006`）を追加し、時刻・主舞台・目的・遷移先を統括管理。
- `src/scenario.js` の第1章本文へ時刻/場所遷移を反映（工房→北区画路地→病院外周→接敵導線）。

### 2.36 第2章〜終章の時空間改訂（同運用へ統一）
- `docs/PLOT_MASTER.md` の第2章〜第6章にも作中時刻と主舞台を具体化し、各章にシーン接続表（3.xE）を追加。
- `src/scenario.js` の `chapter2_main_001` 〜 `chapter6_main_002` 本文へ時刻・場所遷移を反映し、章内の移動と時間経過を明示。
- 分岐ラベル/効果ロジックは維持しつつ、全章で「いつ/どこ」運用を統一。

### 2.37 第2章リビルド（第1章同等の舞台遷移密度）
- `src/scenario.js` の第2章を `chapter2_main_001`〜`006` の6シーンへ再編し、学園→監督役室→市街地→第三交差点→帰路→工房の遷移を明示。
- 分岐は2段（交渉姿勢 / 帰路方針）で維持し、既存パラメータ効果（理想点/同盟/戦術優位/露見）を非破壊で継承。
- `docs/PLOT_MASTER.md` の第2章接続表（3.2E）を6行構成へ更新し、時刻と目的をシーン単位で管理可能化。
- `scripts/validate_sprint3_d3.mjs` を新導線へ同期し、第1章→第2章の回帰検証を継続。

### 2.38 第3章リビルド（第1〜2章同等の舞台遷移密度）
- `src/scenario.js` の第3章を `chapter3_main_001`〜`006` の6シーンへ再編し、旧工業区外縁→高架下外周→廃倉庫裏手→侵攻後路地→工房→河川域移送導線の遷移を明示。
- 分岐（潜入/正面突破）は維持し、既存パラメータ効果（理想点/戦術優位/魔力/一般被害）を非破壊で継承。
- `docs/PLOT_MASTER.md` の第3章接続表（3.3E）を6行構成へ更新し、時刻・舞台・目的・接続をシーン単位で管理可能化。

---

## 3. 現在のファイル責務

- `src/scenario.js`
  - シーン遷移定義
  - 召喚ロジック
  - 戦闘判定
  - 救済・結末判定
- `src/game.js`
  - ストア管理
  - UI描画
  - クリック入力処理
- `index.html`
  - UIレイアウト
- `styles/main.css`
  - 既存テーマ（流用）

---

## 4. 次スレッドで再開するためのメモ

### 4.1 最優先の改善タスク（V1品質向上）
1. [x] サーヴァント別スキル/宝具の個別効果を実装（反映済み）。
2. [x] `checkTags` 連動を実戦投入（戦闘判定へ反映済み）。
3. [x] NPC陣営AIを導入（簡易交戦/潜伏/同盟工作を反映）。
4. [x] テキスト総量を5万字以内で章構成化（設計書 + `src/scenario.js` の章進行接続を反映）。

### 4.2 技術負債
- 敵/自陣ともにクラス別重み + クラス相性を用いた戦闘式へ更新済み。回帰テスト基盤を用いて係数を調整し、通常攻撃/宝具/令呪/撤退の勝率レンジを目標帯へ合わせた。残課題は章別・難度別の微調整。
- 召喚相性ロジックは重み分解型へ更新済み（触媒/ビルド/章/同盟/乱数 + クリップ）。残課題はイベント由来の物語補正データ化。
- セーブ/ロード3枠と既読スキップは実装済み。残課題は自動保存・周回跨ぎUIの改善。

### 4.3 再開手順（別スレッド向け）
1. `docs/GDD.md` と `docs/V1_PLAN.md` を確認。
2. 次期作業は `docs/SPRINT5_PLAN.md` の Step A（文字数再計測と不足分析）から着手。
3. 変更後は本ファイルの「2.実装済み内容」と「4.技術負債」を更新。

---

## 5. 受け入れチェック（現時点）

- [x] 召喚開始〜契約成立まで一連動作
- [x] 日次（昼→夜）ループ
- [x] 夜戦の複数行動分岐
- [x] 令呪消費処理
- [x] 真名看破進行・露見
- [x] 救済導線（1周1回）
- [x] 4種エンディング判定
