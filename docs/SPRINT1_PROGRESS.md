# 開発進捗ログ（Sprint 1〜4）

最終更新: 現在スレッド
担当: Codex
参照仕様: `docs/GDD.md`, `docs/V1_PLAN.md`

---

## 1. 進捗サマリー

- [x] Sprint 1（基盤 / 召喚導入）
- [x] Sprint 2（判定エンジン / 夜戦ループ）
- [x] Sprint 3（7騎反映 / 章進行相当の周回ループ）
- [x] Sprint 4（救済導線 / 結末分岐 / 仕上げ）

> 現在のビルドは、V1_PLANの全Sprint要件を最小実装で通した統合版。

---

## 2. 実装済み内容（最終）

### 2.1 コア基盤
- `createStore(getState/update/reset)` による状態一元管理。
- シーン駆動（`SCENES`）で分岐を管理。
- UIステータスを拡張（看破進行、残存敵、救済状態、結末判定）。

### 2.2 召喚・契約（Sprint 1）
- 主人公ビルド選択（血統型 / 現場型 / 研究型）。
- 触媒選択（4種）と重み付き召喚。
- FSN登場英霊7騎プールで召喚。
- 真名秘匿維持 + 原典と異なるクラス現界の可能性。

### 2.3 戦闘・情報戦（Sprint 2〜3）
- 共通判定関数 `runCheck()` 実装。
- 昼行動（情報収集/工房整備/先制配置）から夜戦へ接続。
- 夜戦行動（通常攻撃/宝具/令呪突破/令呪離脱/撤退）。
- 真名看破進行値（0〜3）と露見処理。
- 敵6陣営の撃破進行と最終戦解放。

### 2.4 サーヴァント個別戦闘効果（V1品質向上）
- FSN初期7騎それぞれに固有スキル補正を追加（ボーナス/被ダメ軽減/撤退補助など）。
- 宝具選択時に英霊別の追加補正と専用ログを反映。
- 宝具の1戦闘1回制限を強制（再使用時は通常攻撃へ自動変換）。

### 2.5 判定タグ連動（V1品質向上）
- 戦闘行動と敵クラスから `checkTags` を生成。
- サーヴァント別タグスキルと一致時に補正（攻撃/防御/撤退/魔力）を適用。
- 発動時はログにタグ一致とスキル名を表示。

### 2.6 令呪・救済・結末（Sprint 4）
- 令呪3画消費処理（突破/離脱/最終戦確定）。
- 救済導線（1周1回）の発動と代償適用。
- 最終戦後に4種の結末判定：
  - 正統勝利
  - 代償勝利
  - 救済生還
  - 破滅

### 2.7 情報開示型看破（V1仕様反映）
- 夜戦の敵情報パネルを追加し、未開示情報を `???` 表示。
- 情報収集で敵ごとの看破Lvを上昇させ、ステータス→スキル→真名/宝具の順で段階開示。
- 敵が戦闘中に使用したスキル/宝具は即時公開。

### 2.8 NPC陣営AI（V1品質向上）
- 昼行動後に他陣営ターンを進行し、交戦/潜伏/同盟工作を実行。
- 他陣営同士のHP増減と脱落を進行ログへ反映。
- 残存陣営が少数化した場合は最終局面フラグを前倒し解放。

### 2.9 データ管理（CSV分割）
- サーヴァント基礎値/戦闘補正/タグ補正/看破開示ルールを `data/csv` へ分割。
- `scripts/generate_csv_data.mjs` で `src/data/generatedData.js` を生成し、実行時データとして利用。

### 2.10 戦闘回帰テスト（Sprint2 A-3）
- `scripts/simulate_battle.mjs` を追加し、通常攻撃/宝具/令呪突破/撤退の回帰を200試行で自動検証可能化。
- 戦闘ログ上でクラス相性ログの出力と、数値状態のNaN混入がないことを検証。

### 2.11 章構成シナリオのゲーム内接続（今回反映）
- 6章（召喚の夜〜聖杯到達）をゲーム状態へ接続し、進行度に応じて章導入と目的表示を切替。
- 中盤（第4章まで）限定のリカバリー導線を追加し、失敗時の再編を代償付きで許容。
- 終盤（第5章以降）で不可逆分岐へ移行するフラグ固定を導入。
- 理想点/一般被害/同盟状態を日中行動に連動させ、結末判定へ反映。

---

## 3. 現在のファイル責務

- `src/scenario.js`
  - シーン遷移定義
  - 召喚ロジック
  - 戦闘判定
  - 救済・結末判定
- `src/game.js`
  - ストア管理
  - UI描画
  - クリック入力処理
- `index.html`
  - UIレイアウト
- `styles/main.css`
  - 既存テーマ（流用）

---

## 4. 次スレッドで再開するためのメモ

### 4.1 最優先の改善タスク（V1品質向上）
1. [x] サーヴァント別スキル/宝具の個別効果を実装（反映済み）。
2. [x] `checkTags` 連動を実戦投入（戦闘判定へ反映済み）。
3. [x] NPC陣営AIを導入（簡易交戦/潜伏/同盟工作を反映）。
4. [x] テキスト総量を5万字以内で章構成化（設計書 + `src/scenario.js` の章進行接続を反映）。

### 4.2 技術負債
- 敵/自陣ともにクラス別重み + クラス相性を用いた戦闘式へ更新済み。回帰テスト基盤を用いて係数を調整し、通常攻撃/宝具/令呪/撤退の勝率レンジを目標帯へ合わせた。残課題は章別・難度別の微調整。
- 召喚時の相性ロジックは簡易（buildBonus中心）。
- セーブ/ロードと既読制御は未実装。

### 4.3 再開手順（別スレッド向け）
1. `docs/GDD.md` と `docs/V1_PLAN.md` を確認。
2. 次期作業は `docs/SPRINT2_PLAN.md` のStep Aから着手。
3. 変更後は本ファイルの「2.実装済み内容」と「4.技術負債」を更新。

---

## 5. 受け入れチェック（現時点）

- [x] 召喚開始〜契約成立まで一連動作
- [x] 日次（昼→夜）ループ
- [x] 夜戦の複数行動分岐
- [x] 令呪消費処理
- [x] 真名看破進行・露見
- [x] 救済導線（1周1回）
- [x] 4種エンディング判定
