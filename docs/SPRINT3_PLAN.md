# Sprint 3 実装計画（章本文本実装 + 分岐品質向上）

最終更新: 現在スレッド  
担当: Codex  
参照仕様: `docs/GDD.md`, `docs/V1_PLAN.md`, `docs/SCENARIO_CHAPTER_PLAN.md`, `docs/SPRINT1_PROGRESS.md`

---

## 0. 進捗ステータス（更新）

- [x] C-1〜C-3: 第5章/第6章本文 + エンディング増補
- [x] D-1: 文字数集計スクリプト追加（`scripts/count_story_chars.mjs`）
- [x] D-2: `???`開示/看破連動/命名規約チェック追加（`scripts/validate_sprint3_d2.mjs`）
- [ ] D-3: 既存進行との最終回帰（継続監視）

---

## 1. Sprint 3の目的

Sprint 3では、Sprint 2で整備した章進行の受け皿に対して、**6章本文を段階的に投入し、プレイ可能な物語体験へ引き上げる**。

- 第1〜第6章の本文シーンを追加し、導入〜終章までの読後感を確立する。
- 中盤（第4章終盤まで）のリカバリー設計と、終盤（第5章以降）の不可逆分岐を本文で明確化する。
- 既存4エンディング（正統勝利 / 代償勝利 / 救済生還 / 破滅）への接続品質を高める。
- 総文字数5万字制約の範囲で、テンポと可読性を両立する。

---

## 2. スコープ

### 2.1 Must（Sprint 3内で完了）
1. **第1章・第2章 本文本実装**
   - 各章「必須2 + 任意1」以上の本文シーンを追加。
   - 章目的・分岐条件（情報優位、同盟成否）を本文上で明示。

2. **第3章・第4章 本文本実装（中盤リカバリー）**
   - 工房崩し〜河川決戦の要点イベントを本文化。
   - 失敗時の代償付き継続導線を本文上で理解可能にする。

3. **第5章・第6章 + 4エンディング本文強化**
   - 真名露見、同盟再確認、願いの選択を本文へ反映。
   - 既存4エンド文面を、判定理由が伝わる形に増補。

4. **文字数管理と整合性チェック**
   - 総文字数49,500字目標（上限50,000字）で調整。
   - `???` 開示ルール、章命名規約、シーン遷移整合を確認。

### 2.2 Should（時間があれば実施）
5. **章間ブリッジ文の追加**
   - 章切替時の状況要約（被害、同盟、看破状況）を短文で追加。

6. **既読スキップ時の読了感補強**
   - 既読高速時でも最低限の章サマリーが残るよう文面を調整。

7. **戦闘要約の本文表示（ログ補助）**
   - 戦闘ログ全文の自動注入は行わず、重要イベントのみ本文側に要約表示する。
   - 要約対象は「与/被ダメ要点」「敵スキル・宝具の露見」「看破進行更新」を優先する。


### 2.3 Out of Scope（Sprint 3ではやらない）
- UI大改修（新演出、画面構成刷新）。
- 戦闘システムの根本仕様変更（係数体系の再設計）。
- 新規クラス/新規サーヴァントの大規模追加。

---

## 3. 実装順（推奨）

### Step A: 第1章・第2章を先行固定（文体・テンポ基準作り）
- A-1: `chapter1_main_*` 本文を投入（必須イベント中心）
- A-2: `chapter2_main_*` 本文を投入（交渉/情報戦を中心）
- A-3: 文体比率（地の文:台詞 ≒ 1:1）をレビュー

### Step B: 第3章・第4章の中盤設計を本文化
- B-1: 侵攻/決戦の分岐本文を追加
- B-2: リカバリー可能終端（第4章）を明示
- B-3: 失敗時再編の代償説明を追記

### Step C: 第5章・第6章とエンディング接続
- C-1: 裏切り/露見/最終戦前提の本文実装
- C-2: 願い選択の価値判断（理想/妥協/拒絶）を明示
- C-3: 4エンディング文面を増補して余韻を強化

### Step D: 仕上げ（制約適合 + 回帰確認）
- D-1: 文字数集計（目標49,500字）
- D-2: `???` 開示、看破連動、命名規約の最終チェック
- D-3: 既存進行（戦闘/救済/結末判定）との回帰確認

---

## 4. タスク分解（1タスク30〜120分）

1. 章本文テンプレート作成（30分）
2. 第1章必須イベント本文（90分）
3. 第1章任意イベント本文（60分）
4. 第2章必須イベント本文（90分）
5. 第2章任意イベント本文（60分）
6. 第3章侵攻分岐本文（120分）
7. 第4章決戦・終端本文（120分）
8. 第5章露見・同盟再編本文（90分）
9. 第6章最終戦・願い本文（90分）
10. 4エンディング増補（90分）
11. 文字数カウントと圧縮調整（60分）
12. 命名・遷移・既読確認（60分）

---

## 5. 受け入れ条件（Doneの定義）

1. 第1〜第6章で、最低限の必須イベント本文が通しで読める。
2. 第4章終了時点で「リカバリー終端」、第5章以降で「不可逆分岐」が本文上で明確。
3. 4エンディングが既存判定と整合し、到達理由が文面から理解できる。
4. 看破未達情報は `???` を維持し、開示条件到達時のみ置換される。
5. 総文字数が50,000字以内（目標49,500字）に収まる。
6. 既存の進行・戦闘・救済導線が破綻しない。

---

## 6. 検証コマンド（Sprint 3運用）

- `node --check src/scenario.js`
- `node --check src/game.js`
- `node scripts/generate_csv_data.mjs`
- `node scripts/simulate_battle.mjs`
- `node scripts/simulate_summon.mjs`
- `node scripts/count_story_chars.mjs`
- `node scripts/validate_sprint3_d2.mjs`

※本文投入後は、手動で以下を最低1周確認:
- 第1章開始〜第2章同盟分岐まで
- 第4章失敗時のリカバリー導線
- 第6章到達後の4エンディング出し分け

---

## 7. リスクと回避策

- **リスク1: 本文量増加でテンポ低下**
  - 対策: 1シーン500〜900字目安を維持し、任意イベントで密度を調整。

- **リスク2: 分岐増加で遷移不整合**
  - 対策: 命名規約に沿って章別プレフィックスを固定し、章末で遷移先を棚卸し。

- **リスク3: 文字数上限超過**
  - 対策: 必須イベント優先で確保し、任意イベントから圧縮。

- **リスク4: 既読スキップで文脈欠落**
  - 対策: 章冒頭/章末に短い要約を設置し、高速読了時の理解を補助。

- **リスク5: 戦闘重要情報がログに埋もれる**
  - 対策: 本文側は要約表示、ログ側は詳細履歴の役割分担を維持する。

---

## 8. Sprint 4への引き継ぎ（想定）

Sprint 3完了後は以下へ移行する。

1. 章本文の最終校正（語調統一、用語統一、誤字修正）。
2. 難度別テキスト差分（初心者向け補足ログ等）の検討。
3. 周回体験の改善（自動保存、周回メタ情報のUI統合）。
4. リリース向け最終回帰（全エンディング到達確認）。
