# Sprint 4 実装計画（昼ランダムイベント拡張）

最終更新: 現在スレッド  
担当: Codex  
参照仕様: `docs/GDD.md`, `docs/V1_PLAN.md`, `docs/SPRINT3_PLAN.md`

---

## 0. 目的

Sprint 4では、既存の「昼行動（情報収集/工房整備/先制配置）」に、**戦闘以外のランダムイベント層**を追加し、
以下を満たす。

- 戦闘以外でも物語と戦略が進む。
- 「選択肢あり/なし」の両形式を共存させる。
- 影響範囲を段階的に広げ、まずは破綻しにくい効果から導入する。

---

## 1. 追加要件（PO指定反映）

### 1.1 イベントカテゴリ
日中イベント抽選は、以下4カテゴリから行う。

1. 共通イベント（全周回で候補）
2. プレイヤーマスタービルド専用イベント（血統型/現場型/研究型）
3. プレイヤーサーヴァント専用イベント（真名ベース）
4. 敵生存サーヴァント専用イベント（生存中の敵真名ベース）

### 1.2 抽選重み（固定）
抽選優先度は下記順を固定する。

- 共通 > プレイヤーサーヴァント専用 > プレイヤービルド専用 > 敵生存サーヴァント専用

初期係数（v1提案）:
- 共通: 50
- プレイヤーサーヴァント専用: 25
- プレイヤービルド専用: 15
- 敵生存サーヴァント専用: 10

※同カテゴリ内はイベント個別weightで再抽選。

### 1.3 選択肢の有無
- 選択肢ありイベント: プレイヤー選択で結果分岐（2〜3択）
- 選択肢なしイベント: 1文面 + 結果即時適用

### 1.4 効果範囲（段階導入）
段階導入方針:

- Phase A（低リスク）
  - 理想点、一般被害、看破進行、魔力、同盟状態の軽微変化
- Phase B（中リスク）
  - 一時バフ/デバフ、関係値、令呪消費機会
- Phase C（高リスク）
  - 新スキル獲得、宝具覚醒、契約変更（再契約/契約不和）

Sprint 4内MustはPhase Aを中心にし、Phase Bは一部まで。Phase Cは後続Sprintで段階開放。

---

## 2. データ設計

### 2.1 最小スキーマ（`dayEvents`）

```js
{
  id: "day_common_watchtower_rumor_001",
  category: "common", // common | masterBuild | playerServant | enemyServant
  weight: 8,
  minChapter: 1,
  maxChapter: 6,
  oncePerRun: false,
  requires: ["enemyAlive>=3"],
  excludes: ["rescueUsed"],
  hasChoices: true,
  text: "…本文…",
  choices: [
    {
      id: "investigate",
      label: "噂の発信源を辿る",
      requires: ["master.mana>=10"],
      outcomes: [
        {
          weight: 70,
          apply: ["intel+1", "mana-10"],
          log: "追跡は成功し、敵陣営の断片情報を得た。"
        },
        {
          weight: 30,
          apply: ["publicDamage+1"],
          log: "攪乱され、一般被害の火種だけが残った。"
        }
      ]
    }
  ],
  autoOutcome: null,
  loreTags: ["霊脈", "真名看破"]
}
```

### 2.2 登録先
- 原本: `data/csv/day_events.csv`（新規）
- 生成: `scripts/generate_csv_data.mjs` に統合
- 実行時: `src/data/generatedData.js` へ出力

### 2.3 影響適用レイヤ
- `src/scenario.js` に `applyDayEventOutcome()` を追加
- 既存フラグ更新関数を再利用し、直接書き換えを避ける

---

## 3. 実行フロー設計

### 3.1 昼フェーズ統合
既存の日中行動の前後どちらかに「ランダムイベント処理」を挿入する。

推奨順:
1. 章/日数の状況判定
2. イベントカテゴリ抽選（カテゴリ重み）
3. 候補イベントのフィルタ（requires/excludes）
4. イベント抽選（個別weight）
5. イベント表示（選択肢あり/なし）
6. 結果適用（outcomes）
7. ログ反映 + 次行動へ遷移

### 3.2 フォールバック
- 抽選対象が0件なら共通イベントの安全候補（no-op寄り）を実行。
- 互換外データは警告ログを出し、イベントスキップで進行継続。

---

## 4. サーヴァント専用イベント設計方針（真名ベース）

クラスではなく**真名ID**でイベントを紐づける。

### 4.1 プレイヤーサーヴァント専用（例）
- アルトリア・ペンドラゴン
  - 「王の責務」: 市民救助優先で一般被害-1、ただし魔力-10。
  - 「理想の王」選択で理想点+1、同盟相手の信頼補正。
- クー・フーリン
  - 「戦士の矜持」: 単独偵察で看破進行+1、失敗時HP小減少。
- メディア
  - 「工房再編」: 工房整備効果上昇、代償として同盟不信フラグ上昇。
- 佐々木小次郎
  - 「山門の一太刀」: 迎撃準備で夜戦先制補正、ただし撤退補正低下。
- ヘラクレス
  - 「狂化の軋み」: 夜戦火力バフ、一般被害リスク上昇。
- メドゥーサ
  - 「静かな監視者」: 追跡成功率上昇、真名露見進行に注意。
- ギルガメッシュ
  - 「王の品定め」: 高リターン交渉（同盟強化）か高リスク挑発（敵対増加）。

### 4.2 敵生存サーヴァント専用（例）
- 敵にギルガメッシュ生存: 「黄金の示威」イベントが抽選解禁（同盟崩壊圧力）。
- 敵にメディア生存: 「結界改変」イベントが抽選解禁（情報収集難化）。
- 敵にハサン系生存: 「影の刺客」イベントが抽選解禁（撤退難化）。

※内容はFate世界観の定番役割（王道/狡知/奇襲/狂化）を参照し、
露骨な原作再演ではなく「V1の分岐設計に噛み合う短編イベント」として実装する。

---

## 5. スコープ（Sprint 4）

### 5.1 Must
1. カテゴリ重み抽選の実装（指定優先順）
2. 選択肢あり/なしイベント両対応
3. 共通イベント 12本以上
4. ビルド専用イベント 各2本（計6本）
5. プレイヤーサーヴァント専用イベント 初期7騎×各1本（計7本）
6. 敵生存サーヴァント専用イベント 6本
7. 効果はPhase A中心（低リスク）

### 5.2 Should
8. プレイヤーサーヴァント専用イベントを各2本へ拡張
9. 一部イベントでPhase B（一時バフ/信頼変化）導入

### 5.3 Out of Scope
- 契約変更/宝具覚醒の本実装（Phase C）
- 新規UI大改修

---

## 6. 実装順（推奨）

### Step A: 土台
- A-1: `day_events.csv` と生成処理追加
- A-2: `scenario.js` に抽選と適用関数を追加
- A-3: no-opフォールバックを実装

### Step B: 低リスクイベント投入
- B-1: 共通12本
- B-2: ビルド専用6本
- B-3: サーヴァント専用（味方7 + 敵6）

### Step C: 選択肢分岐の品質向上
- C-1: 2〜3択の期待値バランス調整
- C-2: 同盟/被害/看破ログの読解性向上

### Step D: 回帰確認
- D-1: 1000回シミュレーションでカテゴリ出現比率を検証
- D-2: セーブ/ロード互換確認
- D-3: 既存4エンディング到達性の回帰確認

---

## 7. 検証方針

### 7.1 自動検証
- `node --check src/scenario.js`
- `node scripts/generate_csv_data.mjs`
- `node scripts/simulate_day_events.mjs`（新規）
  - 1000周試行
  - カテゴリ比率検証（共通>味方鯖>ビルド>敵鯖）
  - 抽選失敗率0%を確認

### 7.2 手動確認
- 昼イベントの選択肢あり/なし双方を確認
- 第1章と第5章でイベント候補が変化することを確認
- 敵生存サーヴァントの撃破後、対応イベントが抽選対象外になることを確認

---

## 8. 導入時期（いつ実装するか）

- **Sprint 4 前半**: Step A〜B（機能を成立させる）
- **Sprint 4 後半**: Step C〜D（バランス調整と回帰）
- **Sprint 5**: Phase B拡張（関係値/一時バフを本格化）
- **Sprint 6以降**: Phase C（宝具覚醒、契約変更）

これにより、まず影響範囲の小さいパラメータ変動から導入し、
ゲーム全体を壊しやすい契約変更・覚醒は後ろ倒しにする。

---

## 9. 受け入れ条件（Done）

1. 昼フェーズでイベント抽選が毎回成立し、進行停止しない。
2. カテゴリ出現率が指定優先度に概ね一致する。
3. 選択肢あり/なしイベントの両方が正常に適用される。
4. 真名ベース専用イベント（味方/敵）が条件付きで発火する。
5. 既存の夜戦・救済・エンディング分岐が破綻しない。
